name: Hotel Backend Pipeline

on:
	push:
		branches: ["main"]

permissions:
	id-token: write
	contents: read

jobs:
	test:
		runs-on: ubuntu-latest
		steps:
			- uses: actions/checkout@v4

			- name: Set up Python
				uses: actions/setup-python@v5
				with:
					python-version: "3.13"

			- name: Install deps
				run: |
					python -m pip install --upgrade pip
					pip install -r requirements.txt
					pip install pytest

			- name: Run unit tests
				run: pytest

	deploy:
		needs: test
		runs-on: ubuntu-latest
		environment: staging
		steps:
			- uses: actions/checkout@v4

			- name: Set up Python
				uses: actions/setup-python@v5
				with:
					python-version: "3.13"

			- name: Configure AWS credentials
				uses: aws-actions/configure-aws-credentials@v4
				with:
					role-to-assume: ${{ vars.STAGING_ROLE_ARN }}
					aws-region: ap-south-1

			- name: Install SAM + tools
				run: |
					python -m pip install --upgrade pip
					pip install aws-sam-cli
					sudo apt-get update
					sudo apt-get install -y jq

			- name: SAM build (with container)
				run: |
					sam build --use-container --template-file deploy/template.yaml

			- name: SAM deploy
				run: |
					sam deploy \
						--template-file deploy/template.yaml \
						--stack-name hotel-backend \
						--parameter-overrides TableName=hotel-checkout JwtSecret=sec \
						--resolve-s3 \
						--capabilities CAPABILITY_IAM \
						--no-confirm-changeset \
						--no-fail-on-empty-changeset \
						--region ap-south-1

			- name: Capture API URL output
				run: |
					API_URL=$(aws cloudformation describe-stacks \
						--stack-name hotel-backend \
						--query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
						--output text)

					if [ "$API_URL" = "None" ] || [ -z "$API_URL" ]; then
						echo "ApiUrl output not found" >&2
						exit 1
					fi

					echo "STAGING_API_URL=$API_URL" >> $GITHUB_ENV
